# 下位机（每辆“地铁”）功能汇总

本文档根据 `source` 目录下的 C 源文件（如 `core.c`、`main.c`、`time_module.c` 等）汇总下位机（每辆学习板视为一辆地铁）的全部功能、关键变量、外设与串口协议，方便理解与后续开发。

---

## 一、总体概述

下位机负责模拟一辆地铁列车的实时运行状态并与上位机/语音模块/显示器等外设交互。主要职责包括：时间/ETA 计算、温度采集与阈值管理、风扇（PWM）控制、速度和剩余里程计算、车门状态管理与语音播报、音乐播放、7 段数码管显示、串口通信协议（与上位机交换状态与配置）、列车 ID 管理、FM 收音机与按键导航等。

## 二、模块与对应源文件（文件 -> 功能）

- `main.c`
  - 初始化外设（ADC、显示、按键、串口、语音/广播模块、音乐模块、EEPROM 等）。
  - 注册系统回调（1s、100ms、UART 接收、导航按键、导航处理等）。
  - 进入主循环 `MySTC_OS()`。

- `core.c`
  - 全局变量定义（`is_door_open[]`、`is_alarm[]`、`id`、`SysClock` 等）。
  - 系统定时回调：`my1S_callback()`（每秒）与 `my100ms_callback()`（每 100ms），负责更新时间、温度、播放/停止音乐、发送当前状态到上位机、风扇控制、显示刷新等。

- `time_module.c`
  - 车站/行程/ETA 管理，包含 `InitRTC()`、`UpdateTime()`、`ResetTimer()`、`onSpeedChange()` 等。
  - 距离、剩余秒数与 ETA 的计算与更新；当到站或计时变更时切换运行/停站模式并触发语音播报。

- `temp_module.c`
  - 温度采集（ADC）和查表转换（`tempdata[]`）实现 `UpdateTemp()`，并通过 `ShowTemp()` 在数码管上显示。

- `nv_temp_threshold.c`
  - 温度阈值的非易失存储（EEPROM，M24C02），提供初始化、读、写与更新接口，防止异常值写入。

- `temp_controlled_fan.c`
  - 根据采集到的温度与阈值启停风扇（通过 `SetPWM()` 控制），函数 `temp_controlled_motor()` 在每秒回调中被调用。

- `speed_module.c`
  - 每辆车的速度数组 `speed[]` 与 `ShowSpeed()`。

- `train_id_module.c`
  - 读取/写入本机列车 ID（EEPROM 地址 `0x10`）。

- `my_uart1.c`
  - 自定义串口（上位机通信）协议实现：接收 CSV 格式命令并解析（`ParseCommand`），更新模块全局变量（速度、门、报警、实时时间、温度阈值等）；每秒通过 `MyUart1SendCurrentStatus()` 发送当前状态到上位机。
  - 支持保存温度阈值到 EEPROM（通过 NV 模块接口 `NVTempThresholdUpdate()`）。

- `voice_module.c`
  - 语音数据（多条中文语音字节数组）与 Uart2 接口的繁忙标志 `Uart2Busy`。
  - `CheckCountdownEvent()` 根据 ETA 与当前模式触发不同语音播报（如到站前播报、车门将要关闭提示等）。

- `radio_module.c`
  - 简单 FM 收音机模块初始化与音量/指示灯配置。

- `music_module.c`
  - 简单的音乐播放控制：当本车门打开并且音乐处于停止时自动开始播放（`is_play_music()`），门关闭时停止。

- `Nav_handler.c`
  - 导航按键处理：切换显示页面、调节 FM 音量等；`ShowStatus()` 根据当前 `displayMode` 决定显示内容（时间/温度/速度/运行模式/实时时间）。

- `decode_table.c`
  - 7 段数码管解码表，用于 `displayer` 模块将数字/字母映射到段码。

- `ultrasonic_module.c`（已注释）
  - 原始代码中有超声波自动门控制的完整实现（读取超声波、步进电机控制门、门开关逻辑和安全报警），但在当前仓库中被注释掉，未启用。

### 注：被注释掉的超声波 & 自动门模块（补充说明）

仓库中 `ultrasonic_module.c` 的实现被用注释块屏蔽，但源码中包含一个较完整的超声波感知与自动门控制设计。为便于后续恢复或参考，下面把注释代码中的设计、关键函数与集成点整理如下：

1. 模块目的
  - 通过超声波传感器检测站台/门口障碍物，自动控制车门的开关（步进电机驱动）；同时在异常或危险情况下发出报警提示，保证乘客安全。

2. 关键全局变量（来自注释代码）
  - `g_distance`：当前超声波测得距离（1024 表示无效）。
  - `ultrasonic_valid`：超声模块有效性标志（0=无效，1=有效）。
  - `last_distances[5]`：历史最近 5 次读数，用于滤波/判定稳定性。
  - `distance_index`：循环索引用于写入历史数组。

3. 主要配置常量
  - `DOOR_MOTOR_SPEED`：步进电机速度（示例：100 步/秒）。
  - `DOOR_OPEN_STEPS` / `DOOR_CLOSE_STEPS`：开门/关门所需步数（正/负值表示方向）。
  - `DOOR_TRIGGER_DISTANCE`：触发开门的距离阈值（示例：10cm）。

4. 主要函数与行为（按注释代码整理）
  - `UltrasonicInit()`：初始化 EXT（外设接口）用于超声波、步进电机初始化、并把车门状态强制为关闭（is_door_open[id] = 0）。初始化历史数组、有效性标志等。

  - `GetUltrasonicDistance()`（静态函数）：
    - 从外设读取当前超声波数值 `distance = GetUltraSonic()`。
    - 保存到 `last_distances[]`，维护循环索引 `distance_index`。
    - 通过比较最近 5 次读数判断是否存在变化（若 5 次读数相同并且值不是显著异常值，则认为是稳定读数或模块故障）。
    - 对异常值（如 0、1023、65535）判为无效并返回 `DISTANCE_INVALID`（注释中用 1024 表示无效）。

  - `UltrasonicUpdateAndDisplay()`：主更新函数，一般被放在定时回调中执行，逻辑包括：
    - 更新 `g_distance`（读取并滤波）。
    - 根据 `mode`（运行模式）与 `is_door_open[id]` 强制或允许开/关门：在某些模式下（例如 RUNNING_MODE=0 表示行驶）会强制关门。
    - 当超声波有效且距离小于触发阈值且当前门为关闭且列车处于停站模式时，尝试打开门（调用 `AutoDoor_Open()`）。
    - 在行驶模式下若检测到非常近的障碍（例如 <=5cm），触发报警（Beep 短促或紧急报警）。
    - 更新门控相关显示（注释中为 `AutoDoor_UpdateDisplay()`）。

  - `AutoDoor_Open()` / `AutoDoor_Close()`：
    - 检查步进电机是否空闲（`GetStepMotorStatus(enumStepMotor1) == enumStepMotorFree`）。
    - 设置 `is_door_open[id]` 状态并调用 `SetStepMotor(enumStepMotor1, speed, steps)` 发起步进电机动作（正转或反转）。
    - 成功时可触发提示音（`SetBeep(...)`），发生异常时保持安全状态。

  - `AutoDoor_EmergencyStop()`：立即停止步进电机（调用 `EmStop(enumStepMotor1)`）。

  - `AutoDoor_IsMotorFree()`：返回步进电机是否空闲（便于上层逻辑决定是否可发起开/关门）。

  - `IsUltrasonicValid()`：返回 `ultrasonic_valid`，上层逻辑可据此决定是否信任测距数据。

5. 滤波与鲁棒性策略
  - 采用 5 次读数一致性检查来判断模块是否稳定或发生故障；若读数全部一致但值为平台所定义的异常值则判为无效。
  - 对无效读数（>= DISTANCE_INVALID）模块会设置 `ultrasonic_valid = 0` 并避免把错误信息用于门控制，从而防止误动作。

6. 与现有系统的集成点
  - `is_door_open[id]`：与主门状态数组共享；自动门函数会设置该标志以便音乐播放、显示与上位机状态同步。
  - `mode`、`station_id`、`rest_total_seconds`：时间/站点模块会影响门控逻辑（例如到站时允许打开门并播放语音）。
  - 步进电机接口（`StepMotorInit`、`SetStepMotor`、`GetStepMotorStatus`、`EmStop`）用于门机驱动。
  - 报警与提示（`SetBeep`）用于反馈异常或门动作完成。

7. 建议（如果打算恢复）
  - 将 `ultrasonic_module.c` 中代码按模块封装为 `ULTRASONIC_ENABLED` 编译开关（宏），以便在需要时编译启用或禁用。
  - 在门动作开始/完成与紧急停止时向上位机发送状态事件，便于上位机展开进一步处理（日志、人工介入等）。
  - 添加一个软件看门狗或故障计数器来处理步进电机长时间不空闲或超声模块持续无效的情况，避免误判。

总结：注释掉的超声波/自动门模块实现提供了一个比较完整的设计（测距、滤波、安全判定、步进电机开关、报警提示），可以较容易地通过添加配置开关与少量 glue-code 恢复并与现有系统的显示、语音与串口逻辑整合。

## 三、关键全局变量（速览）

- `id`：本板的列车 ID（由 `train_id_module` 从 EEPROM 读取）。
- `is_door_open[4]`：4 辆车的门开关状态（1=开，0=关）。
- `is_alarm[4]`：报警状态标志（1=报警）。
- `speed[4]`：每辆车速度（单位不显式标注，代码中用于距离/秒计算）。
- `temperature`：当前温度（整型，由 ADC 查表获得）。
- `tempThresholds[4]`：温度报警阈值，支持 NV 存储读取与写入。
- `rest_total_seconds`、`rest_arrive_minute`、`rest_arrive_second`：ETA/剩余时间相关。
- `Uart2Busy`：语音播放模块是否忙（用于避免同时触发语音）。

## 四、上位机到下位机的串口命令协议（CSV）

解析在 `my_uart1.c::ParseCommand` 中实现，命令字段按顺序（以逗号分割），共计固定字段数（见宏 MY_UART1_FIELD_COUNT）：

字段索引与含义（0 为头部占位）：

1. `id`（列车 ID）
2. `temp`（温度值，注意：实际温度由 ADC 读取，此字段通常不直接覆盖）
3. `tempThresholds`（温度阈值，用于 NV 更新）
4. `speed`（速度）
5. `etaMin`（预计到达分钟）
6. `etaSec`（预计到达秒数）
7. `mode`（运行模式，0/1）
8. `door`（门开关，0/1）
9. `alarm`（报警标志，0/1）
10. `real_hour`（实时时钟小时）
11. `real_minute`
12. `real_second`

收到并解析后，设备会：
- 更新速度并触发 `onSpeedChange()` 来重新计算 ETA；
- 更新温度阈值并写入 EEPROM（如果与当前值不同）；
- 更新门与报警状态；
- 更新实时时钟变量。

下位机每秒会通过 `MyUart1SendCurrentStatus()` 向上位机发送一条 CSV 状态行，包含：`id,temperature,tempThreshold,speed,etaMin,etaSec,mode,door,alarm,real_hour,real_minute,real_second`，以 `\n` 结尾。

## 五、语音/广播逻辑

- 语音文本以字节数组形式保存在 `voice_module.c`（`VOICE_STRING_1/2/3`）中。
- `CheckCountdownEvent()` 根据 `rest_total_seconds`、`station_id` 与 `mode` 决定何时通过 `Uart2Print()` 播放哪条语音。
- 播放时会检查 `Uart2Busy`（由串口接收回调 `myUart2Rxd_callback()` 更新），避免打断正在播放的语音。

## 六、显示逻辑

- 使用 7 段数码管显示，解码表见 `decode_table.c`。
- 通过 `ShowStatus()` 根据 `displayMode` 切换显示页面：
  - 页面 0：ETA（`ShowTime()`）
  - 页面 1：温度（`ShowTemp()`）
  - 页面 2：速度（`ShowSpeed()`）
  - 页面 3：运行模式（`ShowMode()`）
  - 页面 4：实时时间（`ShowRealTime()`）

## 七、硬件/外设交互（概览）

- ADC：温度传感器读取。
- PWM：控制风扇（`SetPWM()`）。
- I2C EEPROM（M24C02）：保存列车 ID 与温度阈值。
- 串口 UART1：上位机通信（自定义 CSV 协议）。
- 串口 UART2：语音播放（与语音模块/解码器通信）。
- 步进电机/超声（未启用）：代码中存在自动门逻辑但被注释。

## 八、已注释/未启用的功能

- 超声波感知与自动门控制（`ultrasonic_module.c`）存在完整实现，但在当前工程中被注释掉，不参与运行。

## 九、边界情况与注意点（工程建议）

1. 温度处理：上位机发来的 `temp` 字段不会直接覆盖传感器读数；真实温度由 ADC 读取并查表得到。
2. NV 写入：为了防止 EEPROM 频繁写入，代码中只在阈值变化时写入（`NVTempThresholdUpdate`）。
3. 语音并发：语音播放前检查 `Uart2Busy`，确保不会中断当前语音。
4. 串口发送缓冲：`MyUart1SendCurrentStatus()` 固定发送 50 字节缓冲（宏），需确保缓冲大小与字段长度兼容。

## 十、快速索引（文件 -> 关键函数）

- `main.c` : `main()`
- `core.c` : `my1S_callback()`, `my100ms_callback()`
- `time_module.c` : `InitRTC()`, `UpdateTime()`, `ResetTimer()`, `onSpeedChange()`
- `temp_module.c` : `UpdateTemp()`, `ShowTemp()`
- `temp_controlled_fan.c` : `temp_controlled_motor()`
- `nv_temp_threshold.c` : `NVTempThresholdInit()`, `NVTempThresholdRead()`, `NVTempThresholdWrite()`, `NVTempThresholdUpdate()`
- `my_uart1.c` : `MyUart1Init()`, `ParseCommand()`, `MyUart1SendCurrentStatus()`
- `voice_module.c` : `myUart2Rxd_callback()`, `CheckCountdownEvent()`
- `music_module.c` : `is_play_music()`, `set_music()`

---

如果你希望我把这份文档翻译为英文、把语音字节数组反向解码为可读文本、或把串口协议写成更正式的文档（包括示例报文与校验），告诉我我会继续完善并把文档补充到仓库。 

（文档由源码逐文件阅读生成：`source/*.c`，已包含注释与实现点。）
