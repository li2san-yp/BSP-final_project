# 地铁车厢监控上位机系统功能总结

## 一、功能概述

您的上位机系统是一个基于Qt 6.9.2框架开发的**地铁车厢实时监控与控制系统**，采用选项卡式界面设计，主要服务于**站务员（张师傅）**和**维护工程师（王工）**两类用户，实现对多节车厢的温度、门状态、安防等关键参数的实时监控、远程控制和维护诊断。

## 二、详细功能分析

### 1. 全景状态实时监控面板 📊

**需求对应：** ✅ 站务员（张师傅）核心需求

#### 功能实现：
- **车厢列表一览：** 实时显示车厢1、2、3的状态表格
- **关键状态可视化：** 7列信息展示（车厢号、温度、报警阈值、车速、到站时间、车门状态、报警状态）
- **异常高亮报警：** 温度超阈值或安防报警时，整行变红背景并触发系统提示音
- **实时数据更新：** 接收下位机数据后立即刷新界面显示

#### 技术实现思路：
- 使用Qt的**QTableWidget**组件构建状态监控表格，通过**QTableWidgetItem**管理每个数据单元格
- 利用Qt的**信号槽机制**，当SerialManager接收到串口数据时，立即触发StatusPage的updateStatus方法
- 通过**QTableWidgetItem的setBackground**方法实现异常状态的红色高亮显示
- 使用**QApplication::beep()**实现系统提示音功能
- 采用**QTimer定时器机制**确保界面的实时性更新

### 2. 报警事件管理与日志记录 📝

**需求对应：** ✅ 维护工程师（王工）+ 站务员（张师傅）

#### 功能实现：
- **报警事件列表：** 实时显示时间、车厢号、报警类型、具体内容
- **智能报警冷却：** 同一车厢1分钟内只记录一次报警，避免日志刷屏
- **自动本地存储：** 所有报警自动保存到 `alarms.csv` 文件
- **一键导出功能：** 支持选择路径导出完整报警历史

#### 技术实现思路：
- 采用**AlarmLog类**封装报警管理逻辑，内部使用**QTableWidget**展示报警列表
- 使用**QDateTime**记录精确的时间戳，并用**QMap**缓存各车厢的最后报警时间实现冷却机制
- 利用Qt的**QFile和QTextStream**进行CSV文件的自动写入，采用**QStringConverter::System**确保中文编码兼容
- 通过**QFileDialog**提供用户友好的文件保存路径选择界面
- 实现实时滚动显示，使用**QTableWidget的scrollToBottom**方法确保最新报警信息可见

### 3. 远程指令下发与控制 🎮

**需求对应：** ✅ 站务员（张师傅）+ 维护工程师（王工）

#### 功能实现：
- **车厢选择：** 支持单独车厢或广播（所有车厢）控制
- **参数配置：** 温度阈值设置、车速控制、车门状态、安防报警开关
- **智能自动填充：** 每10秒自动填充当前车厢的实时参数值
- **协议通信：** 使用自定义BSP协议格式进行结构化数据传输

#### 技术实现思路：
- 使用**ControlPage类**构建控制界面，采用**QComboBox**实现车厢选择，**QSpinBox和QCheckBox**实现参数输入
- 利用Qt**信号槽机制**，当用户切换车厢时触发carSelected信号，主窗口响应并推送对应车厢的缓存数据
- 通过**QTimer**实现10秒间隔的自动填充功能，避免频繁的界面更新影响用户操作
- 设计**BSP协议**（包头+8个数据字段），使用固定32字节帧格式确保串口传输的可靠性
- 采用**QByteArray**进行数据帧的构建和填充，确保协议的标准化传输

### 4. 诊断与维护接口 🔧

**需求对应：** ✅ 维护工程师（王工）专用

#### 功能实现：
- **历史温度曲线：** 实时绘制各车厢温度变化趋势，支持1000个数据点缓存
- **数据导出功能：** 可选择车厢和抽样间隔（1-60秒）导出CSV格式温度历史
- **整数精度显示：** 坐标轴和工具提示均显示整数值，避免浮点数误导
- **多车厢对比：** 同时显示多个车厢的温度曲线，便于故障分析

#### 技术实现思路：
- 使用**Qt Charts模块**的**QChart、QChartView和QLineSeries**实现专业级的温度曲线绘制
- 采用**QMap**管理多个车厢的**QLineSeries**对象，实现多曲线同时显示和动态更新
- 通过**QVector<QPoint>**存储整数坐标的温度历史数据，避免浮点数精度问题
- 使用**QValueAxis的setLabelFormat**方法强制坐标轴显示整数格式
- 实现自定义**事件过滤器（eventFilter）**来控制鼠标悬停时的工具提示显示整数坐标
- 采用**数据抽样机制**，根据用户选择的时间间隔对原始数据进行抽取，减少导出文件大小
- 使用**环形缓冲区概念**，限制内存中最多保存1000个数据点，防止内存溢出

## 三、核心技术架构

### 1. 串口通信管理

- **多串口并发管理：** 使用**QSerialPort类**管理COM2、COM3、COM5三个串口的并发通信
- **动态映射学习：** 通过帧解析自动建立串口与车厢ID的映射关系，解决硬件连接顺序不确定的问题
- **连接状态监控：** 实时检测串口连接状态，实现断线自动重连和错误恢复机制
- **缓冲区管理：** 使用**QByteArray**实现按行分割的数据缓冲，支持\r\n和\n两种换行格式

### 2. 数据存储与处理

- **内存数据管理：** 使用**QMap容器**管理各车厢的实时状态缓存和历史数据存储
- **数据类型优化：** 采用整数类型存储温度等参数，避免浮点数精度问题
- **阈值同步机制：** 实现上位机与下位机之间的温度阈值双向同步
- **历史数据压缩：** 使用滑动窗口机制限制历史数据量，保持系统性能

### 3. 用户界面设计

- **模块化页面架构：** 使用**QTabWidget**实现四个功能模块的清晰分离
- **响应式界面更新：** 基于Qt**信号槽机制**实现数据驱动的界面自动刷新
- **用户体验优化：** 采用中文本地化界面，提供直观的状态指示和操作反馈
- **视觉层次设计：** 通过颜色编码、表格布局等方式突出重要信息

### 4. 数据持久化策略

- **实时数据保存：** 使用Qt的**文件I/O机制**实现报警日志的实时写入
- **用户自定义导出：** 通过**QFileDialog**提供灵活的数据导出路径选择
- **编码兼容处理：** 使用**QStringConverter**确保中文数据的正确编码和显示
- **文件格式标准化：** 采用CSV格式确保数据的跨平台兼容性和易读性

## 四、协议设计

### BSP通信协议规格

**协议格式：** `BSP,carId,temp,tempThreshold,speed,etaMin,etaSec,mode,door,alarm,hour,minute,second`

| 字段 | 类型 | 说明 |
|------|------|------|
| BSP | 字符串 | 协议包头标识 |
| carId | 整数 | 车厢编号（1-3） |
| temp | 整数 | 当前温度（℃） |
| tempThreshold | 整数 | 温度报警阈值（℃） |
| speed | 整数 | 当前车速（m/s） |
| etaMin | 整数 | 到站剩余分钟数 |
| etaSec | 整数 | 到站剩余秒数 |
| mode | 整数 | 运行模式（0=运行/ETA显示，1=停站/停站时间显示） |
| door | 整数 | 车门状态（0=关闭，1=打开） |
| alarm | 整数 | 安防报警状态（0=正常，1=报警） |
| hour | 整数 | 实时小时（0-23，由上位机发送） |
| minute | 整数 | 实时分钟（0-59，由上位机发送） |
| second | 整数 | 实时秒钟（0-59，由上位机发送） |

**传输特性：**
- 固定50字节帧长度，不足部分用NULL字符填充
- 支持单播（指定车厢）和广播（所有车厢）两种模式
- 自动重连和错误恢复机制
- 时间字段由上位机自动添加当前时间，用于同步下位机时钟

## 五、系统价值体现

### 对站务员（张师傅）的价值

1. **🔍 消除信息盲区**
   - 实时7项关键参数监控，无死角覆盖车厢状态
   - 异常自动高亮显示，第一时间发现问题

2. **⚡ 提升工作效率**
   - 一键广播控制，快速应对紧急情况
   - 自动报警提示，减少人工巡检频率

### 对维护工程师（王工）的价值

1. **📊 数据洞察力**
   - 温度历史曲线分析，识别设备老化趋势
   - 完整的报警日志记录，支持故障复盘

2. **🎛️ 远程控制力**
   - 灵活的参数配置能力，远程调整设备运行状态
   - 数据导出功能，支持深度分析和报告编写

3. **🔧 维护便利性**
   - 整数精度显示，避免浮点数造成的误解
   - 抽样导出机制，高效处理大量历史数据

## 六、技术特色与创新点

1. **🔄 动态串口映射** - 自适应硬件连接顺序变化
2. **⏰ 智能报警冷却** - 避免日志刷屏，提升系统稳定性
3. **📈 整数精度图表** - 工业级数据显示标准
4. **🔗 双向参数同步** - 上下位机参数一致性保证
5. **📁 实时数据持久化** - 零数据丢失的可靠性设计

---

**总结：** 您的系统完美回应了站务员对"效率、实时性"和维护工程师对"洞察力、控制力"的核心需求，是一个功能完整、技术先进的工业级监控解决方案！