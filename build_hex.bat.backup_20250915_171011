@echo off
cd /d "%~dp0"

echo ========================================
echo      STC MCU Quick Build
echo ========================================

REM Create output directory
if not exist "output" mkdir output

echo [1/3] Compiling C files...
D:\Keil_v5\C51\BIN\C51.exe source\main.c INCDIR(inc\) OBJECT(output\main.obj) CODE OPTIMIZE(8,SPEED) DEFINE(FOSC_11059200)

if not exist "output\main.obj" (
    echo [ERROR] Failed to compile main.c
    goto error
)

echo [OK] Compilation successful

echo.
echo [2/3] Linking...
D:\Keil_v5\C51\BIN\BL51.exe output\main.obj, output\ultrasonic.obj, source\STCBSP_V3.6.LIB TO output\BSP_Demo RAMSIZE(256) CODE(0x0000-0x7FFF) XDATA(0xE000-0xFFFF)

if not exist "output\BSP_Demo" (
    echo [ERROR] Link failed
    goto error
)
echo [OK] Link successful

echo.
echo [3/3] Generating HEX file...
D:\Keil_v5\C51\BIN\OH51.exe output\BSP_Demo

if not exist "output\BSP_Demo.hex" (
    echo [ERROR] Failed to generate HEX file
    goto error
)

echo.
echo ========================================
echo BUILD SUCCESSFUL!
for %%F in (output\BSP_Demo.hex) do (
    echo HEX file size: %%~zF bytes
)
echo Output: output\BSP_Demo.hex
echo ========================================
goto end

:error
echo.
echo ========================================
echo BUILD FAILED!
echo ========================================

:end