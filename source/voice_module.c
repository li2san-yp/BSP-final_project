#include "core.h"

unsigned char xdata Uart2RxBuf = 0; // 串口2接收字节
unsigned char xdata Uart2Busy = 0;  // =0：语言合成模块空闲  =1：语言合成模块正在播放语音中
unsigned int xdata voice_time_1[5] = {0, 15, 15, 15, 15}; 

code unsigned char VOICE_STRING_1[5][300] = {
    {0}, 
    // "平阳，到了。请前往黎托路的乘客准备下车。下车时，请注意列车与站台之间的间隙。"
    {0xC6, 0xBD, 0xD1, 0xF4, 0xA3, 0xAC, 0xB5, 0xBD, 0xC1, 0xCB, 0xA1, 0xA3, 0xC7, 0xEB, 0xC7, 0xB0, 0xCD, 0xF9, 0xC0, 0xE8, 0xCD, 0xD0, 0xC2, 0xB7, 0xB5, 0xC4, 0xB3, 0xCB, 0xBF, 0xCD, 0xD7, 0xBC, 0xB1, 0xB8, 0xCF, 0xC2, 0xB3, 0xB5, 0xA1, 0xA3, 0xCF, 0xC2, 0xB3, 0xB5, 0xCA, 0xB1, 0xA3, 0xAC, 0xC7, 0xEB, 0xD7, 0xA2, 0xD2, 0xE2, 0xC1, 0xD0, 0xB3, 0xB5, 0xD3, 0xEB, 0xD5, 0xBE, 0xCC, 0xA8, 0xD6, 0xAE, 0xBC, 0xE4, 0xB5, 0xC4, 0xBC, 0xE4, 0xCF, 0xB6, 0xA1, 0xA3, 0x00},
    // "长沙火车南站，到了。本站为换乘站，可换乘2号线、磁浮S2线。请前往高铁南站、磁浮S2线、黎托高速汽车站的乘客准备下车。下车时，请注意列车与站台之间的间隙。"
    {0xB3, 0xA4, 0xC9, 0xB3, 0xBB, 0xF0, 0xB3, 0xB5, 0xC4, 0xCF, 0xD5, 0xBE, 0xA3, 0xAC, 0xB5, 0xBD, 0xC1, 0xCB, 0xA1, 0xA3, 0xB1, 0xBE, 0xD5, 0xBE, 0xCE, 0xAA, 0xBB, 0xBB, 0xB3, 0xCB, 0xD5, 0xBE, 0xA3, 0xAC, 0xBF, 0xC9, 0xBB, 0xBB, 0xB3, 0xCB, 0x32, 0xBA, 0xC5, 0xCF, 0xDF, 0xA1, 0xA2, 0xB4, 0xC5, 0xB8, 0xA1, 0x53, 0x32, 0xCF, 0xDF, 0xA1, 0xA3, 0xC7, 0xEB, 0xC7, 0xB0, 0xCD, 0xF9, 0xB8, 0xDF, 0xCC, 0xFA, 0xC4, 0xCF, 0xD5, 0xBE, 0xA1, 0xA2, 0xB4, 0xC5, 0xB8, 0xA1, 0x53, 0x32, 0xCF, 0xDF, 0xA1, 0xA2, 0xC0, 0xE8, 0xCD, 0xD0, 0xB8, 0xDF, 0xCB, 0xD9, 0xC6, 0xFB, 0xB3, 0xB5, 0xD5, 0xBE, 0xB5, 0xC4, 0xB3, 0xCB, 0xBF, 0xCD, 0xD7, 0xBC, 0xB1, 0xB8, 0xCF, 0xC2, 0xB3, 0xB5, 0xA1, 0xA3, 0xCF, 0xC2, 0xB3, 0xB5, 0xCA, 0xB1, 0xA3, 0xAC, 0xC7, 0xEB, 0xD7, 0xA2, 0xD2, 0xE2, 0xC1, 0xD0, 0xB3, 0xB5, 0xD3, 0xEB, 0xD5, 0xBE, 0xCC, 0xA8, 0xD6, 0xAE, 0xBC, 0xE4, 0xB5, 0xC4, 0xBC, 0xE4, 0xCF, 0xB6, 0xA1, 0xA3, 0x00},
    // "光达（会展中心），到了。本站为换乘站，可换乘2号线。请前往长沙国际会议中心、长沙国际会展中心、长沙国际会展新城的乘客准备下车。下车时，请注意列车与站台之间的间隙。"
    {0xB9, 0xE2, 0xB4, 0xEF, 0xA3, 0xA8, 0xBB, 0xE1, 0xD5, 0xB9, 0xD6, 0xD0, 0xD0, 0xC4, 0xA3, 0xA9, 0xA3, 0xAC, 0xB5, 0xBD, 0xC1, 0xCB, 0xA1, 0xA3, 0xB1, 0xBE, 0xD5, 0xBE, 0xCE, 0xAA, 0xBB, 0xBB, 0xB3, 0xCB, 0xD5, 0xBE, 0xA3, 0xAC, 0xBF, 0xC9, 0xBB, 0xBB, 0xB3, 0xCB, 0x32, 0xBA, 0xC5, 0xCF, 0xDF, 0xA1, 0xA3, 0xC7, 0xEB, 0xC7, 0xB0, 0xCD, 0xF9, 0xB3, 0xA4, 0xC9, 0xB3, 0xB9, 0xFA, 0xBC, 0xCA, 0xBB, 0xE1, 0xD2, 0xE9, 0xD6, 0xD0, 0xD0, 0xC4, 0xA1, 0xA2, 0xB3, 0xA4, 0xC9, 0xB3, 0xB9, 0xFA, 0xBC, 0xCA, 0xBB, 0xE1, 0xD5, 0xB9, 0xD6, 0xD0, 0xD0, 0xC4, 0xA1, 0xA2, 0xB3, 0xA4, 0xC9, 0xB3, 0xB9, 0xFA, 0xBC, 0xCA, 0xBB, 0xE1, 0xD5, 0xB9, 0xD0, 0xC2, 0xB3, 0xC7, 0xB5, 0xC4, 0xB3, 0xCB, 0xBF, 0xCD, 0xD7, 0xBC, 0xB1, 0xB8, 0xCF, 0xC2, 0xB3, 0xB5, 0xA1, 0xA3, 0xCF, 0xC2, 0xB3, 0xB5, 0xCA, 0xB1, 0xA3, 0xAC, 0xC7, 0xEB, 0xD7, 0xA2, 0xD2, 0xE2, 0xC1, 0xD0, 0xB3, 0xB5, 0xD3, 0xEB, 0xD5, 0xBE, 0xCC, 0xA8, 0xD6, 0xAE, 0xBC, 0xE4, 0xB5, 0xC4, 0xBC, 0xE4, 0xCF, 0xB6, 0xA1, 0xA3, 0x00},
    // "终点站，杜家坪，到了。请全体乘客携带好随身物品准备下车。下车时，请注意列车与站台之间的间隙。欢迎您再次乘坐地铁列车，再见！"
    {0xD6, 0xD5, 0xB5, 0xE3, 0xD5, 0xBE, 0xA3, 0xAC, 0xB6, 0xC5, 0xBC, 0xD2, 0xC6, 0xBA, 0xA3, 0xAC, 0xB5, 0xBD, 0xC1, 0xCB, 0xA1, 0xA3, 0xC7, 0xEB, 0xC8, 0xAB, 0xCC, 0xE5, 0xB3, 0xCB, 0xBF, 0xCD, 0xD0, 0xAF, 0xB4, 0xF8, 0xBA, 0xC3, 0xCB, 0xE6, 0xC9, 0xED, 0xCE, 0xEF, 0xC6, 0xB7, 0xD7, 0xBC, 0xB1, 0xB8, 0xCF, 0xC2, 0xB3, 0xB5, 0xA1, 0xA3, 0xCF, 0xC2, 0xB3, 0xB5, 0xCA, 0xB1, 0xA3, 0xAC, 0xC7, 0xEB, 0xD7, 0xA2, 0xD2, 0xE2, 0xC1, 0xD0, 0xB3, 0xB5, 0xD3, 0xEB, 0xD5, 0xBE, 0xCC, 0xA8, 0xD6, 0xAE, 0xBC, 0xE4, 0xB5, 0xC4, 0xBC, 0xE4, 0xCF, 0xB6, 0xA1, 0xA3, 0xBB, 0xB6, 0xD3, 0xAD, 0xC4, 0xFA, 0xD4, 0xD9, 0xB4, 0xCE, 0xB3, 0xCB, 0xD7, 0xF8, 0xB5, 0xD8, 0xCC, 0xFA, 0xC1, 0xD0, 0xB3, 0xB5, 0xA3, 0xAC, 0xD4, 0xD9, 0xBC, 0xFB, 0xA3, 0xA1, 0x00}
};

// "车门即将关闭，谨防夹伤。"
code unsigned char VOICE_STRING_2[100] = {0xB3, 0xB5, 0xC3, 0xC5, 0xBC, 0xB4, 0xBD, 0xAB, 0xB9, 0xD8, 0xB1, 0xD5, 0xA3, 0xAC, 0xBD, 0xF7, 0xB7, 0xC0, 0xBC, 0xD0, 0xC9, 0xCB, 0x00};

code unsigned char VOICE_STRING_3[5][200] = {
    {0}, 
    // "本次列车开往，杜家坪。下一站，平阳。车门开启方向为左侧。"
    {0xB1, 0xBE, 0xB4, 0xCE, 0xC1, 0xD0, 0xB3, 0xB5, 0xBF, 0xAA, 0xCD, 0xF9, 0xA3, 0xAC, 0xB6, 0xC5, 0xBC, 0xD2, 0xC6, 0xBA, 0xA1, 0xA3, 0xCF, 0xC2, 0xD2, 0xBB, 0xD5, 0xBE, 0xA3, 0xAC, 0xC6, 0xBD, 0xD1, 0xF4, 0xA1, 0xA3, 0xB3, 0xB5, 0xC3, 0xC5, 0xBF, 0xAA, 0xC6, 0xF4, 0xB7, 0xBD, 0xCF, 0xF2, 0xCE, 0xAA, 0xD7, 0xF3, 0xB2, 0xE0, 0xA1, 0xA3, 0x00},
    // "本次列车开往，杜家坪。下一站，长沙火车南站。车门开启方向为左侧。各位乘客请注意，需换乘2号线、磁浮S2线的乘客，请在长沙火车南站下车。"
    {0xB1, 0xBE, 0xB4, 0xCE, 0xC1, 0xD0, 0xB3, 0xB5, 0xBF, 0xAA, 0xCD, 0xF9, 0xA3, 0xAC, 0xB6, 0xC5, 0xBC, 0xD2, 0xC6, 0xBA, 0xA1, 0xA3, 0xCF, 0xC2, 0xD2, 0xBB, 0xD5, 0xBE, 0xA3, 0xAC, 0xB3, 0xA4, 0xC9, 0xB3, 0xBB, 0xF0, 0xB3, 0xB5, 0xC4, 0xCF, 0xD5, 0xBE, 0xA1, 0xA3, 0xB3, 0xB5, 0xC3, 0xC5, 0xBF, 0xAA, 0xC6, 0xF4, 0xB7, 0xBD, 0xCF, 0xF2, 0xCE, 0xAA, 0xD7, 0xF3, 0xB2, 0xE0, 0xA1, 0xA3, 0xB8, 0xF7, 0xCE, 0xBB, 0xB3, 0xCB, 0xBF, 0xCD, 0xC7, 0xEB, 0xD7, 0xA2, 0xD2, 0xE2, 0xA3, 0xAC, 0xD0, 0xE8, 0xBB, 0xBB, 0xB3, 0xCB, 0x32, 0xBA, 0xC5, 0xCF, 0xDF, 0xA1, 0xA2, 0xB4, 0xC5, 0xB8, 0xA1, 0x53, 0x32, 0xCF, 0xDF, 0xB5, 0xC4, 0xB3, 0xCB, 0xBF, 0xCD, 0xA3, 0xAC, 0xC7, 0xEB, 0xD4, 0xDA, 0xB3, 0xA4, 0xC9, 0xB3, 0xBB, 0xF0, 0xB3, 0xB5, 0xC4, 0xCF, 0xD5, 0xBE, 0xCF, 0xC2, 0xB3, 0xB5, 0xA1, 0xA3, 0x00},
    // "本次列车开往，杜家坪。下一站，光达（会展中心）。车门开启方向为左侧。各位乘客请注意，需换乘2号线的乘客，请在光达（会展中心）下车。"
    {0xB1, 0xBE, 0xB4, 0xCE, 0xC1, 0xD0, 0xB3, 0xB5, 0xBF, 0xAA, 0xCD, 0xF9, 0xA3, 0xAC, 0xB6, 0xC5, 0xBC, 0xD2, 0xC6, 0xBA, 0xA1, 0xA3, 0xCF, 0xC2, 0xD2, 0xBB, 0xD5, 0xBE, 0xA3, 0xAC, 0xB9, 0xE2, 0xB4, 0xEF, 0xA3, 0xA8, 0xBB, 0xE1, 0xD5, 0xB9, 0xD6, 0xD0, 0xD0, 0xC4, 0xA3, 0xA9, 0xA1, 0xA3, 0xB3, 0xB5, 0xC3, 0xC5, 0xBF, 0xAA, 0xC6, 0xF4, 0xB7, 0xBD, 0xCF, 0xF2, 0xCE, 0xAA, 0xD7, 0xF3, 0xB2, 0xE0, 0xA1, 0xA3, 0xB8, 0xF7, 0xCE, 0xBB, 0xB3, 0xCB, 0xBF, 0xCD, 0xC7, 0xEB, 0xD7, 0xA2, 0xD2, 0xE2, 0xA3, 0xAC, 0xD0, 0xE8, 0xBB, 0xBB, 0xB3, 0xCB, 0x32, 0xBA, 0xC5, 0xCF, 0xDF, 0xB5, 0xC4, 0xB3, 0xCB, 0xBF, 0xCD, 0xA3, 0xAC, 0xC7, 0xEB, 0xD4, 0xDA, 0xB9, 0xE2, 0xB4, 0xEF, 0xA3, 0xA8, 0xBB, 0xE1, 0xD5, 0xB9, 0xD6, 0xD0, 0xD0, 0xC4, 0xA3, 0xA9, 0xCF, 0xC2, 0xB3, 0xB5, 0xA1, 0xA3, 0x00},
    // "下一站，是本次列车终点站，杜家坪。车门开启方向为左侧。列车运行时，请站稳扶好，请为有需要的乘客让座，多谢合作。"
    {0xCF, 0xC2, 0xD2, 0xBB, 0xD5, 0xBE, 0xA3, 0xAC, 0xCA, 0xC7, 0xB1, 0xBE, 0xB4, 0xCE, 0xC1, 0xD0, 0xB3, 0xB5, 0xD6, 0xD5, 0xB5, 0xE3, 0xD5, 0xBE, 0xA3, 0xAC, 0xB6, 0xC5, 0xBC, 0xD2, 0xC6, 0xBA, 0xA1, 0xA3, 0xB3, 0xB5, 0xC3, 0xC5, 0xBF, 0xAA, 0xC6, 0xF4, 0xB7, 0xBD, 0xCF, 0xF2, 0xCE, 0xAA, 0xD7, 0xF3, 0xB2, 0xE0, 0xA1, 0xA3, 0xC1, 0xD0, 0xB3, 0xB5, 0xD4, 0xCB, 0xD0, 0xD0, 0xCA, 0xB1, 0xA3, 0xAC, 0xC7, 0xEB, 0xD5, 0xBE, 0xCE, 0xC8, 0xB7, 0xF6, 0xBA, 0xC3, 0xA3, 0xAC, 0xC7, 0xEB, 0xCE, 0xAA, 0xD3, 0xD0, 0xD0, 0xE8, 0xD2, 0xAA, 0xB5, 0xC4, 0xB3, 0xCB, 0xBF, 0xCD, 0xC8, 0xC3, 0xD7, 0xF9, 0xA3, 0xAC, 0xB6, 0xE0, 0xD0, 0xBB, 0xBA, 0xCF, 0xD7, 0xF7, 0xA1, 0xA3, 0x00} 
};

// 串口2接收字节回调函数 - 简化调试版本
void myUart2Rxd_callback()
{
    if (Uart2RxBuf == 0x41)
        Uart2Busy = 1; // 模块忙碌
    else
        Uart2Busy = 0; // 默认为空闲
}

// 检查倒计时事件并播放对应语音
void CheckCountdownEvent()
{
    // 如果语音模块正忙，直接返回，不进行新的播放
    if (Uart2Busy == 1)
        return;

    // 在特定时间点播放对应语音 - 使用字符串字面量与正确示例保持一致
    if (rest_total_seconds == voice_time_1[station_id] && mode == 0)
    {
        Uart2Print(VOICE_STRING_1[station_id], sizeof(VOICE_STRING_1[station_id]));
    }
    else if (rest_total_seconds == 5 && mode == 1)
    {
        Uart2Print(VOICE_STRING_2, sizeof(VOICE_STRING_2));
    }
    else if (rest_total_seconds == 0 && mode == 1)
    {
        Uart2Print(VOICE_STRING_3[station_id], sizeof(VOICE_STRING_3[station_id]));
    }
}
